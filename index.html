<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSCWC Chess Crypto Kings</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: "Poppins", Arial, sans-serif;
      text-align: center;
      overflow-x: hidden;
    }
    h1{ font-size:1.8em; color:gold; letter-spacing:1px; margin:12px 0 0 }
    h2.slogan{ font-style:italic; color:#ffd700; font-weight:400; margin-top:-6px; margin-bottom:12px }

    /* top coin */
    #top3D{
      width:100%;
      height:220px;
      display:flex;
      justify-content:center;
      align-items:center;
      background: radial-gradient(circle at center, rgba(255,215,0,0.03), transparent 25%), #000;
    }
    .coin{
      width:140px;height:140px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffdf00 0%, #b8860b 90%);
      display:flex;align-items:center;justify-content:center;
      box-shadow: inset 3px 3px 8px rgba(255,255,255,0.35), inset -3px -3px 10px rgba(0,0,0,0.35), 0 0 30px rgba(255,215,0,0.65);
      animation: spin 10s linear infinite;
      transform-style: preserve-3d;
    }
    .coin svg{ width:72px;height:72px; fill:#fff8dc; filter: drop-shadow(0 0 8px rgba(255,215,0,0.25)); }
    @keyframes spin{ 0%{ transform: rotateY(0deg) } 100%{ transform: rotateY(360deg) } }

    /* controls */
    .toolbar{ margin:8px auto 6px; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap }
    input[type="email"]{ padding:10px 12px; border-radius:10px; border:1px solid #333; width:260px; background:#111; color:#fff; outline:none }
    button{ padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .btn-pink{ background:#ff4fd8; color:#fff }
    .btn-blue{ background:#0099ff; color:#fff }
    .btn-green{ background:#29a745; color:#fff }
    .btn-yellow{ background:#ffc107; color:#000 }
    .btn-orange{ background:#ff9900; color:#000 }
    button:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,0.25) }

    /* status line */
    #status { margin-top:10px; color:#ddd; font-size:0.95rem; min-height:1.2rem }

    /* chess area */
    #chessContainer{
      width:100%;
      padding:28px 0;
      background: radial-gradient(circle at center, #000 60%, #111 100%);
      border-top:2px solid gold;
      box-shadow: 0 0 25px rgba(255,200,50,0.06);
      display:flex; justify-content:center;
    }

    /* responsive square board */
    #board{
      width: min(560px, 94vw);
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(8,1fr);
      grid-template-rows: repeat(8,1fr);
      border:2px solid gold;
      box-shadow: 0 0 18px rgba(200,160,30,0.22);
      background-clip: padding-box;
      touch-action: none;
    }

    .square{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      position:relative;
    }
    .light{ background:#f0d9b5; }
    .dark{ background:#b58863; }

    /* pieces: inline SVGs auto-scale */
    .piece{ width:78%; height:78%; display:block; pointer-events:none; }
    @media (max-width:420px){ .piece{ width:72%; height:72% } }

    /* outlines for selection */
    .square.selected { outline: 3px solid rgba(255,215,0,0.6); outline-offset: -3px; }

    /* small footer spacing on mobile */
    .bottom-gap{ height:48px }

  </style>
</head>
<body>

  <div id="top3D">
    <div class="coin" aria-hidden="true">
      <!-- Bitcoin 'B' glyph centered -->
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" focusable="false">
        <rect x="42" y="12" width="4" height="76" rx="1" />
        <rect x="54" y="12" width="4" height="76" rx="1" />
        <path d="M45 22h10a8 8 0 0 1 0 16H45zM45 44h12a8 8 0 0 1 0 16H45z" />
      </svg>
    </div>
  </div>

  <h1>SSCWC Chess Crypto Kings</h1>
  <h2 class="slogan">The Future of Gold on Blockchain</h2>

  <div class="toolbar" id="authToolbar">
    <input id="emailInput" type="email" placeholder="Your email (for quick sign-in)" />
    <button id="sendLinkBtn" class="btn-pink">Send Magic Link</button>
    <button id="connectBtn" class="btn-blue">Connect Wallet (BSC Testnet)</button>
    <button id="createBtn" class="btn-green">Create Game</button>
  </div>

  <div style="margin:8px 0;">
    <a id="buyBtnWrap" href="https://app.uniswap.org/explore/tokens/bnb/0xd7deadbf768dec8ac13850e4f6787ac53a9d0447?utm_medium=mobile&utm_source=share-tdp" target="_blank" rel="noopener noreferrer">
      <button class="btn-orange">ðŸª™ Buy SSCWC on Uniswap</button>
    </a>
  </div>

  <div id="status" role="status">Not signed in â€” enter email and click Send Magic Link</div>

  <div id="chessContainer">
    <div id="board" role="grid" aria-label="Chessboard"></div>
  </div>

  <div class="bottom-gap"></div>

  <!-- load chess.js (UMD build exposes window.Chess) -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.6/dist/chess.min.js"></script>

  <script type="module">
    // Firebase modular imports (v10) - keep your config here
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // ---------- Your Firebase config (from earlier) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCiU4bLmbd5pJ6sv13TAMIk4eh8Exhid4o",
      authDomain: "sscwc-chess.firebaseapp.com",
      databaseURL: "https://sscwc-chess-default-rtdb.firebaseio.com",
      projectId: "sscwc-chess",
      storageBucket: "sscwc-chess.firebasestorage.app",
      messagingSenderId: "382398698085",
      appId: "1:382398698085:web:cc902f0f1b6b1b93602c8c"
    };
    // -------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const emailInput = document.getElementById('emailInput');
    const sendLinkBtn = document.getElementById('sendLinkBtn');
    const statusEl = document.getElementById('status');
    const boardEl = document.getElementById('board');

    // Chess.js game object
    const ChessCtor = window.Chess || window.ChessJS || window.Chessboard; // attempt common names
    if (typeof window.Chess === 'undefined') {
      console.warn('chess.js not found at window.Chess â€” ensure chess.js loaded. Using fallback minimal rules disabled.');
    }
    const game = (typeof window.Chess === 'function') ? new window.Chess() : null;

    // SVG generator for pieces (flat metallic)
    function svgFor(type, color){
      const goldFill = '#D4AF37', goldRim = '#B8860B';
      const silverFill = '#C0C0C0', silverRim = '#9E9E9E';
      const fill = color === 'w' ? goldFill : silverFill;
      const rim  = color === 'w' ? goldRim : silverRim;
      const highlight = color === 'w' ? '#fffaf0' : '#f2f2f2';
      const commonSVGStart = `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${color} ${type}">`;
      const commonSVGEnd = `</svg>`;

      switch(type){
        case 'p':
          return commonSVGStart +
            `<circle cx="60" cy="38" r="15" fill="${rim}"/><circle cx="60" cy="38" r="12" fill="${fill}"/><rect x="42" y="58" width="36" height="30" rx="4" fill="${rim}"/><rect x="44" y="60" width="32" height="26" rx="4" fill="${fill}"/><ellipse cx="60" cy="92" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        case 'r':
          return commonSVGStart +
            `<rect x="34" y="28" width="52" height="64" fill="${rim}"/><rect x="36" y="30" width="48" height="60" fill="${fill}"/><rect x="28" y="22" width="12" height="8" fill="${rim}"/><rect x="44" y="22" width="12" height="8" fill="${rim}"/><rect x="60" y="22" width="12" height="8" fill="${rim}"/><ellipse cx="60" cy="94" rx="36" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        case 'n':
          return commonSVGStart +
            `<path d="M38 90 C36 68, 54 56, 70 54 C82 52, 88 46, 86 36 C84 26, 74 24, 64 28 C56 30, 52 38, 48 40 C44 42, 38 38, 34 42 C32 46, 38 54, 44 58 C34 66, 36 90, 38 90 Z" fill="${rim}"/><path d="M42 86 C40 66, 56 54, 70 52 C80 50, 84 44, 82 36 C80 28, 72 26, 64 30 C56 32, 52 38, 48 40 C44 42, 38 38, 36 42 C34 46, 38 54, 44 58 C34 66, 38 86, 42 86 Z" fill="${fill}"/><circle cx="68" cy="40" r="2.8" fill="${highlight}"/><ellipse cx="60" cy="94" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        case 'b':
          return commonSVGStart +
            `<path d="M60 28 C46 48, 38 58, 38 74 L82 74 C82 58, 74 48, 60 28 Z" fill="${rim}"/><path d="M60 32 C48 50, 42 58, 42 74 L78 74 C78 58, 72 50, 60 32 Z" fill="${fill}"/><rect x="58" y="40" width="4" height="24" fill="${highlight}" opacity="0.65" transform="rotate(-20 60 52)"/><ellipse cx="60" cy="94" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        case 'q':
          return commonSVGStart +
            `<path d="M24 62 L34 40 L46 62 L60 36 L74 62 L86 40 L96 62 L96 76 L24 76 Z" fill="${rim}"/><path d="M28 64 L34 44 L46 64 L60 40 L74 64 L86 44 L92 64 L92 72 L28 72 Z" fill="${fill}"/><circle cx="34" cy="40" r="4" fill="${highlight}"/><circle cx="60" cy="36" r="4" fill="${highlight}"/><circle cx="86" cy="40" r="4" fill="${highlight}"/><ellipse cx="60" cy="94" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        case 'k':
          return commonSVGStart +
            `<path d="M24 58 L36 36 L48 58 L60 40 L72 58 L84 36 L96 58 L96 76 L24 76 Z" fill="${rim}"/><path d="M28 60 L36 40 L48 60 L60 44 L72 60 L84 40 L92 60 L92 72 L28 72 Z" fill="${fill}"/><rect x="56" y="18" width="8" height="20" fill="${rim}" /><rect x="52" y="26" width="16" height="6" fill="${fill}" /><ellipse cx="60" cy="94" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>` +
            commonSVGEnd;
        default:
          return commonSVGStart + `<circle cx="60" cy="60" r="44" fill="${fill}" stroke="${rim}" stroke-width="4"/>` + commonSVGEnd;
      }
    }

    // Build empty board (8x8 grid squares)
    const files = ['a','b','c','d','e','f','g','h'];
    function buildBoardGrid(){
      boardEl.innerHTML = '';
      for(let r=0;r<8;r++){
        for(let f=0;f<8;f++){
          const sq = document.createElement('div');
          sq.className = 'square ' + ((r + f) % 2 === 0 ? 'light' : 'dark');
          sq.dataset.square = files[f] + (8 - r);
          boardEl.appendChild(sq);
        }
      }
    }
    buildBoardGrid();

    // Keep references for selection
    let selectedSquare = null;

    // chess.js game object (null if chess.js failed to load)
    let chessGame = null;
    if (typeof window.Chess === 'function') {
      chessGame = new window.Chess();
    } else {
      console.warn('chess.js not available; moves will not be validated.');
    }

    // render pieces from chessGame position
    function renderFromFenOrInitial(){
      // clear squares
      const squares = boardEl.querySelectorAll('.square');
      squares.forEach(sq => sq.innerHTML = '');
      if(!chessGame){ return; } // nothing to render
      const boardMatrix = chessGame.board(); // rank 8 .. 1
      // boardEl children are appended in same order we created (rank 8 row first)
      for(let r=0;r<8;r++){
        for(let f=0;f<8;f++){
          const piece = boardMatrix[r][f];
          if(piece){
            const idx = r*8 + f;
            const sqEl = boardEl.children[idx];
            sqEl.innerHTML = svgFor(piece.type, piece.color);
          }
        }
      }
    }

    // initial setup
    function newGame(){
      if(chessGame) chessGame.reset();
      renderFromFenOrInitial();
      statusEl.textContent = `Not signed in â€” sign in to play AI` ;
    }

    // Click handling (select + move)
    boardEl.addEventListener('click', (ev) => {
      const sq = ev.target.closest('.square');
      if(!sq || !sq.dataset.square) return;
      const sqName = sq.dataset.square;
      // if user not signed in playing still allowed locally, but AI only responds when signed in
      // selection
      if(!selectedSquare){
        // only allow selecting squares that contain a white piece (player = white)
        if(!chessGame){ selectedSquare = sqName; sq.classList.add('selected'); return; }
        const p = chessGame.get(sqName);
        if(p && p.color === 'w'){ selectedSquare = sqName; sq.classList.add('selected'); }
        return;
      } else {
        // attempt move
        const from = selectedSquare;
        const to = sqName;
        // remove highlight
        const prevEl = [...boardEl.children].find(el => el.dataset.square === selectedSquare);
        if(prevEl) prevEl.classList.remove('selected');
        selectedSquare = null;
        if(!chessGame){ statusEl.textContent = 'No chess engine loaded'; return; }
        const move = chessGame.move({ from, to, promotion: 'q' });
        if(move){
          renderFromFenOrInitial();
          statusEl.textContent = (currentUserEmail ? 'Playing AI (level 3)' : 'Signed out â€” sign in to enable AI');
          // AI reply after small delay
          setTimeout(()=> aiMove(), 140);
        } else {
          statusEl.textContent = 'Illegal move';
          setTimeout(()=> statusEl.textContent = (currentUserEmail ? 'Playing AI (level 3)' : 'Not signed in - sign in to play AI'), 900);
        }
      }
    });

    // ------------------ Stockfish engine (worker) with fallback ------------------
    const STOCKFISH_URL = 'https://cdn.jsdelivr.net/npm/stockfish@15.1.0/src/stockfish.js';
    let engine = null;
    let engineReady = false;
    let engineSupports = false;
    let useFallback = false;

    // fallback AI: choose random legal move
    function fallbackAIMove(){
      if(!chessGame) return;
      const moves = chessGame.moves();
      if(!moves || moves.length === 0) return;
      // pick random
      const m = moves[Math.floor(Math.random()*moves.length)];
      chessGame.move(m);
      renderFromFenOrInitial();
      // game over check
      checkGameOver();
    }

    function startEngine(skill=3){
      // Attempt to create worker
      try {
        engine && engine.terminate();
        engine = new Worker(STOCKFISH_URL);
      } catch(e){
        console.warn('Stockfish worker creation failed:', e);
        engine = null;
      }
      if(!engine){
        // can't use worker - fallback
        engineReady = false;
        useFallback = true;
        statusEl.textContent = 'Engine unavailable â€” using fallback AI';
        return;
      }

      engine.onmessage = (ev) => {
        const data = typeof ev.data === 'string' ? ev.data : ev.data?.message;
        if(!data) return;
        // listen for uci messages
        if(data.indexOf('uciok') === 0){ engine.postMessage('isready'); }
        if(data.indexOf('readyok') === 0){
          engineReady = true;
          engineSupports = true;
          engine.postMessage('ucinewgame');
          // set skill if supported (older builds may not have Skill)
          try { engine.postMessage('setoption name Skill Level value ' + skill); } catch(e){}
        }
        if(data.indexOf('bestmove') === 0){
          const parts = data.split(' ');
          const best = parts[1];
          if(best && best.length >= 4){
            const from = best.slice(0,2), to = best.slice(2,4);
            chessGame.move({ from, to, promotion: 'q' });
            renderFromFenOrInitial();
            checkGameOver();
          }
        }
      };
      // initialize
      engine.postMessage('uci');
      useFallback = false;
      statusEl.textContent = 'Starting engine...';
    }

    function aiMove(){
      if(!chessGame) return;
      if(useFallback || !engine || !engineReady){
        // fallback
        fallbackAIMove();
        return;
      }
      // instruct engine with current fen and ask for move
      const fen = chessGame.fen();
      engine.postMessage('position fen ' + fen);
      // depth 10 is moderate strength â€” adjust for performance
      engine.postMessage('go depth 10');
    }

    function checkGameOver(){
      if(!chessGame) return;
      if(chessGame.game_over()){
        if(chessGame.in_checkmate()){
          // who delivered mate? check turn to see who is to move now
          const winner = chessGame.turn() === 'w' ? 'Black (AI) wins' : 'White (You) wins';
          statusEl.textContent = 'Checkmate â€” ' + winner;
        } else {
          statusEl.textContent = 'Game over â€” draw/stalemate';
        }
      }
    }

    // ------------------ Firebase magic-link and auth state ------------------
    let currentUserEmail = null;

    sendLinkBtn.addEventListener('click', async () => {
      const email = emailInput.value && emailInput.value.trim().toLowerCase();
      if(!email){
        alert('Enter a valid email');
        return;
      }
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true
      };
      try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem('emailForSignIn', email);
        alert('Magic link sent â€” check your email');
        statusEl.textContent = 'Magic link sent â€” check your email';
      } catch(err){
        console.error('sendSignInLinkToEmail', err);
        alert('Failed to send link: ' + (err.message || err));
      }
    });

    async function tryCompleteSignIn(){
      try {
        if(isSignInWithEmailLink(auth, window.location.href)){
          let email = localStorage.getItem('emailForSignIn');
          if(!email) email = window.prompt('Enter the email you used to sign in');
          if(!email) return;
          const result = await signInWithEmailLink(auth, email, window.location.href);
          localStorage.removeItem('emailForSignIn');
          statusEl.textContent = 'Signed in: ' + (result.user?.email || '(no email)');
        }
      } catch(err){
        console.error('Completing sign-in failed', err);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(user){
        currentUserEmail = user.email || null;
        statusEl.textContent = 'Signed in: ' + (currentUserEmail || '(no-email)') + ' â€” Starting AI match';
        try {
          await addDoc(collection(db, 'logins'), { email: currentUserEmail || 'unknown', ts: serverTimestamp() });
        } catch(e){ console.warn('Failed logging to Firestore', e); }
        // start engine & game
        startEngine(3);
        newGame();
      } else {
        currentUserEmail = null;
        statusEl.textContent = 'Not signed in â€” enter your email and click "Send Magic Link"';
        // stop engine
        if(engine){ try{ engine.terminate(); }catch(e){} engine=null; engineReady=false; }
        useFallback = true;
        newGame();
      }
    });

    // attempt to complete sign-in on page load
    tryCompleteSignIn();

    // Setup board and initial game on load
    newGame();

    // Buttons placeholders: wallet/create
    document.getElementById('connectBtn').addEventListener('click', () => {
      alert('Wallet connect placeholder â€” implement BSC wallet connect here (e.g. Web3Modal / MetaMask).');
    });
    document.getElementById('createBtn').addEventListener('click', () => {
      alert('Create game placeholder â€” integrate on-chain create/contract logic here.');
    });

    // If engine isn't available after a short delay, fall back automatically
    setTimeout(()=> {
      if(!engine && !useFallback){
        // try starting engine anyway
        startEngine(3);
      }
      if(!engine && !useFallback) useFallback = true;
      if(useFallback) statusEl.textContent = 'Engine not available â€” using fallback AI';
    }, 1800);

  </script>
</body>
</html>
