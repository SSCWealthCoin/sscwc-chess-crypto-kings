<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSCWC Chess Crypto Kings</title>

  <style>
    /* Basic layout */
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:"Poppins", Arial, sans-serif;
      text-align:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header & coin */
    #top {
      width:100%;
      background: radial-gradient(circle at 50% 18%, rgba(255,215,0,0.03), transparent 25%), #000;
      padding:28px 8px 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      gap:6px;
    }

    .coin {
      width:136px;
      height:136px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at 30% 30%, #ffd84d 0%, #c18c08 85%);
      box-shadow: inset 3px 3px 12px rgba(255,255,255,0.20),
                  inset -6px -6px 18px rgba(0,0,0,0.45),
                  0 0 46px rgba(255,200,30,0.18);
      transform-style: preserve-3d;
      /* initial rotation animation (only once) */
    }

    /* rotate once (we will add this class at load) */
    .rotate-once { animation: spinOnce 1.6s linear 1 forwards; }

    @keyframes spinOnce{
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }

    /* shimmer class toggled after spin completes */
    .shimmer::after{
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      pointer-events: none;
      background: radial-gradient(circle at 50% 35%, rgba(255,215,0,0.22), rgba(255,215,0,0.08) 25%, transparent 50%);
      mix-blend-mode: screen;
      filter: blur(14px);
      animation: shimmerPulse 2.2s ease-in-out infinite;
    }

    @keyframes shimmerPulse{
      0% { opacity: 0.45; transform: scale(0.98); }
      50% { opacity: 0.9; transform: scale(1.01); }
      100% { opacity: 0.45; transform: scale(0.98); }
    }

    /* Place coin image inside (optional overlay) */
    .coin img {
      width: 68%;
      height: 68%;
      object-fit:contain;
      border-radius:50%;
      display:block;
    }

    /* Headline */
    h1 {
      margin:10px 0 0;
      font-size:28px;
      color:#ffd400;
      letter-spacing:0.6px;
      font-weight:800;
    }
    h2.slogan{
      margin:4px 0 12px;
      font-style:italic;
      color:#ffd777;
      font-weight:500;
      margin-bottom:14px;
    }

    /* Buttons */
    .toolbar { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:6px 12px 0; }
    a.btn, button.btn {
      display:inline-block;
      padding:10px 16px;
      border-radius:10px;
      border: none;
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
      transition: transform .14s, box-shadow .14s;
    }
    a.btn { background:#ffbf00; color:#111; }
    .pink { background:#ff4fd8; color:#fff; }
    .blue { background:#0099ff; color:#fff; }
    .green { background:#29a745; color:#fff; }
    .yellow { background:#ffc107; color:#111; }
    a.btn:hover, button.btn:hover{ transform: translateY(-2px); box-shadow:0 6px 18px rgba(255,200,25,0.12); }

    /* status line */
    #status { margin:10px 0 0; color:rgba(255,255,255,0.9); font-size:0.95rem; }

    /* Chess area */
    #chessContainer {
      width:100%;
      padding:28px 10px 60px;
      border-top:2px solid gold;
      box-shadow:0 0 25px rgba(255,200,50,0.06);
      display:flex;
      justify-content:center;
      background: radial-gradient(circle at center, #000 60%, #0b0b0b 100%);
    }

    /* Board responsive square */
    #board {
      width: min(640px, 92vw);
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap:0;
      border: 4px solid rgba(212,160,40,0.95);
      box-shadow: 0 0 28px rgba(212,160,40,0.12);
      background-clip: padding-box;
    }

    .square {
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      user-select:none;
      overflow:hidden;
    }
    .light { background:#f0d9b5; }
    .dark  { background:#b58863; }

    /* scale svg pieces to cell */
    .piece {
      width:78%;
      height:78%;
      display:block;
      pointer-events:none;
    }

    /* smaller screens */
    @media (max-width:420px){
      h1{ font-size:24px }
      .coin { width:116px; height:116px }
      .piece { width:72%; height:72% }
    }

    /* small highlight when selecting */
    .square.selected { outline: 3px solid rgba(255,215,0,0.65); outline-offset: -2px; }

    /* error text */
    #error { color:#ff6666; margin-top:8px; font-weight:600; }

  </style>
</head>
<body>

  <div id="top">
    <div class="coin rotate-once" id="coin">
      <!-- Use your uploaded coin image (ensure file exists in the same folder). If you want a pure SVG B replace the <img> -->
      <img src="Gifcmr3XoAA_WF-.jpeg" alt="SSCWC Coin" id="coinImg">
    </div>

    <h1>SSCWC Chess Crypto Kings</h1>
    <h2 class="slogan">The Future of Gold on Blockchain</h2>

    <div class="toolbar" id="controls">
      <input id="emailInput" type="email" placeholder="Your email (for quick sign-in)" style="padding:10px;border-radius:10px;border:1px solid #333;background:#0b0b0b;color:#fff" />
      <button class="btn pink" id="sendLinkBtn">Send Magic Link</button>
      <button class="btn blue" id="connectBtn">Connect Wallet (BSC Testnet)</button>
      <button class="btn green" id="createBtn">Create Game</button>
    </div>

    <div style="margin-top:8px;">
      <a class="btn" id="buyBtn" href="https://app.uniswap.org/explore/tokens/bnb/0xd7deadbf768dec8ac13850e4f6787ac53a9d0447?utm_medium=mobile&utm_source=share-tdp" target="_blank" rel="noopener">ðŸª™ Buy SSCWC on Uniswap</a>
    </div>

    <div id="status">Not signed in â€” enter email and click "Send Magic Link"</div>
    <div id="error" aria-live="polite"></div>
  </div>

  <div id="chessContainer">
    <div id="board" role="grid" aria-label="Chessboard"></div>
  </div>

  <!-- Libraries: chess.js (v1.x), we will attempt to load Stockfish worker; fallback implemented -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.6/chess.min.js"></script>

  <script type="module">
    // -------------------------
    // Firebase config & imports
    // -------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // ---------- REPLACE / VERIFY ---------- (You provided earlier; keep or replace)
    const firebaseConfig = {
      apiKey: "AIzaSyCiU4bLmbd5pJ6sv13TAMIk4eh8Exhid4o",
      authDomain: "sscwc-chess.firebaseapp.com",
      databaseURL: "https://sscwc-chess-default-rtdb.firebaseio.com",
      projectId: "sscwc-chess",
      storageBucket: "sscwc-chess.firebasestorage.app",
      messagingSenderId: "382398698085",
      appId: "1:382398698085:web:cc902f0f1b6b1b93602c8c"
    };
    // ---------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------------------------
    // Coin animation logic
    // -------------------------
    const coin = document.getElementById('coin');
    // after the rotate-once animation ends, add shimmer class (pure gold)
    coin.addEventListener('animationend', (e) => {
      if (e.animationName === 'spinOnce') {
        coin.classList.remove('rotate-once');
        coin.classList.add('shimmer');
      }
    });

    // -------------------------
    // Chessboard & pieces
    // -------------------------
    const boardEl = document.getElementById('board');
    const files = ['a','b','c','d','e','f','g','h'];
    const Chess = window.Chess; // chess.js attaches Chess to window for this CDN
    const game = new Chess();

    // SVG pieces factory (flat metallic tokens)
    function svgFor(type, color) {
      // color: 'w' (gold) or 'b' (silver)
      const goldFill = '#D4AF37', goldRim = '#B8860B', silverFill = '#C0C0C0', silverRim = '#9E9E9E';
      const fill = color === 'w' ? goldFill : silverFill;
      const rim  = color === 'w' ? goldRim : silverRim;
      const highlight = color === 'w' ? '#fffaf0' : '#f2f2f2';

      // shapes simplified and flat so they read well on mobile and desktop
      switch (type.toLowerCase()) {
        case 'p':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="60" cy="36" r="14" fill="${rim}" />
                    <circle cx="60" cy="36" r="11" fill="${fill}" />
                    <rect x="44" y="56" width="32" height="26" rx="4" fill="${rim}" />
                    <rect x="46" y="58" width="28" height="22" rx="3" fill="${fill}" />
                    <ellipse cx="60" cy="92" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        case 'r':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <rect x="34" y="30" width="52" height="52" fill="${rim}" />
                    <rect x="36" y="32" width="48" height="48" fill="${fill}" />
                    <rect x="28" y="22" width="12" height="8" fill="${rim}" />
                    <rect x="44" y="22" width="12" height="8" fill="${rim}" />
                    <rect x="60" y="22" width="12" height="8" fill="${rim}" />
                    <ellipse cx="60" cy="96" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        case 'n':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <path d="M40 86 C42 66, 58 58, 70 56 C82 54, 88 46, 86 36 C84 26, 74 24, 64 28 C56 30, 52 38, 48 40 C44 42, 38 38, 34 42 C32 46, 38 54, 44 58 C34 66, 36 86, 40 86 Z" fill="${rim}"/>
                    <path d="M44 82 C46 64, 60 56, 72 54 C82 52, 86 44, 84 36 C82 28, 74 26, 66 28 C58 30, 54 36, 50 40 C46 42, 40 38, 38 42 C36 46, 40 54, 46 58 C36 66, 40 82, 44 82 Z" fill="${fill}"/>
                    <circle cx="70" cy="38" r="3" fill="${highlight}" />
                    <ellipse cx="60" cy="96" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        case 'b':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <path d="M60 28 C46 46, 36 56, 36 72 L84 72 C84 56, 74 46, 60 28 Z" fill="${rim}"/>
                    <path d="M60 32 C48 48, 40 56, 40 72 L80 72 C80 56, 72 48, 60 32 Z" fill="${fill}"/>
                    <rect x="58" y="40" width="4" height="24" fill="${highlight}" opacity="0.7" transform="rotate(-20 60 52)"/>
                    <ellipse cx="60" cy="96" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        case 'q':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 64 L34 40 L46 64 L60 36 L74 64 L86 40 L96 64 L96 78 L24 78 Z" fill="${rim}"/>
                    <path d="M28 66 L34 44 L46 66 L60 40 L74 66 L86 44 L92 66 L92 76 L28 76 Z" fill="${fill}"/>
                    <circle cx="34" cy="40" r="3" fill="${highlight}"/><circle cx="60" cy="36" r="3" fill="${highlight}"/><circle cx="86" cy="40" r="3" fill="${highlight}"/>
                    <ellipse cx="60" cy="96" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        case 'k':
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 60 L36 36 L48 60 L60 40 L72 60 L84 36 L96 60 L96 78 L24 78 Z" fill="${rim}"/>
                    <path d="M28 62 L36 44 L48 62 L60 46 L72 62 L84 44 L92 62 L92 76 L28 76 Z" fill="${fill}"/>
                    <rect x="56" y="16" width="8" height="22" fill="${rim}" /><rect x="52" y="26" width="16" height="6" fill="${fill}" />
                    <ellipse cx="60" cy="96" rx="34" ry="6" fill="rgba(0,0,0,0.06)"/>
                  </svg>`;
        default:
          return `<svg class="piece" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="60" r="44" fill="${fill}" stroke="${rim}" stroke-width="4"/></svg>`;
      }
    }

    // Build board squares
    function buildBoard() {
      boardEl.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
          const el = document.createElement('div');
          el.className = 'square ' + ((r + f) % 2 === 0 ? 'light' : 'dark');
          const sq = files[f] + (8 - r);
          el.dataset.square = sq;
          boardEl.appendChild(el);
        }
      }
    }
    buildBoard();

    // Place pieces based on game state
    function renderBoard() {
      // clear squares
      const squares = boardEl.querySelectorAll('.square');
      squares.forEach(sq => sq.innerHTML = '');

      // chess.js board returns array [rank8..rank1]
      const boardObj = game.board();
      for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
          const piece = boardObj[r][f];
          if (piece) {
            const index = r * 8 + f;
            const sqEl = boardEl.children[index];
            const svg = svgFor(piece.type, piece.color === 'w' ? 'w' : 'b');
            sqEl.innerHTML = svg;
          }
        }
      }
    }

    renderBoard();

    // Click-to-move (player = white)
    let selected = null;
    boardEl.addEventListener('click', (ev) => {
      const sq = ev.target.closest('.square');
      if (!sq) return;
      const square = sq.dataset.square;
      if (!square) return;

      // only allow player moves if signed in (makes sense for gating)
      // but we will permit moves regardless for demo â€” comment/uncomment based on policy
      // if (!currentUserEmail) { setStatus('Sign in to play'); return; }

      // select source
      if (!selected) {
        const p = game.get(square);
        if (p && p.color === 'w') {
          selected = square;
          sq.classList.add('selected');
        }
        return;
      }

      // try move
      const move = game.move({ from: selected, to: square, promotion: 'q' });
      // clear selection highlight
      const prev = [...boardEl.children].find(c => c.dataset.square === selected);
      if (prev) prev.classList.remove('selected');
      selected = null;

      if (move) {
        renderBoard();
        checkGameState();
        // AI reply
        setTimeout(() => aiMakeMove(), 160);
      } else {
        // illegal move - ignore
      }
    });

    function checkGameState() {
      if (game.in_checkmate()) {
        setStatus('Checkmate â€” ' + (game.turn() === 'b' ? 'You win!' : 'AI wins'));
      } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
        setStatus('Draw');
      } else {
        setStatus(currentUserEmail ? 'Playing AI (level 3)' : 'Not signed in â€” sign in to enable features');
      }
    }

    // -------------------------
    // AI engine (try Stockfish worker, fallback to simple algorithm)
    // -------------------------
    const STOCKFISH_WORKER_URL = 'https://cdn.jsdelivr.net/npm/stockfish@15.1.0/src/stockfish.js';
    let engine = null;
    let engineReady = false;
    let engineAvailable = false;
    let fallback = false;

    function startEngine(skill=3) {
      engineReady = false;
      engineAvailable = false;
      fallback = false;

      try {
        engine = new Worker(STOCKFISH_WORKER_URL);
      } catch (err) {
        console.warn('Worker failed, Stockfish not loaded as worker:', err);
        engine = null;
      }

      if (engine) {
        engine.onmessage = function (e) {
          const msg = typeof e.data === 'string' ? e.data : e.data?.message;
          if (!msg) return;
          if (msg.indexOf('uciok') === 0) {
            engine.postMessage('isready');
          } else if (msg.indexOf('readyok') === 0) {
            engineReady = true;
            engineAvailable = true;
            engine.postMessage('ucinewgame');
            // set skill via setoption if supported
            engine.postMessage('setoption name Skill Level value ' + skill);
            setStatus('Engine ready â€” playing AI (level ' + skill + ')');
          } else if (msg.indexOf('bestmove') === 0) {
            const parts = msg.split(' ');
            if (parts[1]) {
              const mv = parts[1].trim();
              const from = mv.substring(0,2);
              const to = mv.substring(2,4);
              game.move({ from, to, promotion: 'q' });
              renderBoard();
              checkGameState();
            }
          }
        };
        // start handshake
        engine.postMessage('uci');
        // fallback guard: if engine doesn't signal ready in X seconds -> fallback
        setTimeout(() => {
          if (!engineReady) {
            console.warn('Engine not ready in time â€” falling back');
            try { engine.terminate(); } catch(e) {}
            engine = null;
            engineReady = false;
            engineAvailable = false;
            fallback = true;
            setStatus('Engine not available â€” using fallback AI');
          }
        }, 3000);
      } else {
        // no engine -> fallback
        fallback = true;
        setStatus('Engine not available â€” using fallback AI');
      }
    }

    // basic fallback move: choose a legal move biased toward capturing or center
    function fallbackChooseMove() {
      const moves = game.moves({ verbose: true });
      if (!moves || moves.length === 0) return null;

      // prefer captures
      const captures = moves.filter(m => m.flags && m.flags.indexOf('c') !== -1);
      if (captures.length) return captures[Math.floor(Math.random() * captures.length)];

      // prefer center moves (to, containing e4,d4,e5,d5)
      const center = ['e4','d4','e5','d5','c4','f4'];
      const centerMoves = moves.filter(m => center.includes(m.to));
      if (centerMoves.length) return centerMoves[Math.floor(Math.random() * centerMoves.length)];

      // otherwise random
      return moves[Math.floor(Math.random() * moves.length)];
    }

    function aiMakeMove() {
      if (game.game_over()) return;
      // if engine available and ready -> ask it
      if (engine && engineAvailable && engineReady) {
        const fen = game.fen();
        engine.postMessage('position fen ' + fen);
        // depth 12 for reasonable strength; Stockfish may ignore Skill Level if setoption isn't supported in this build
        engine.postMessage('go depth 12');
        return;
      }
      // otherwise fallback move
      const chosen = fallbackChooseMove();
      if (chosen) {
        game.move({ from: chosen.from, to: chosen.to, promotion: 'q' });
        renderBoard();
        checkGameState();
      }
    }

    // -------------------------
    // Status / UI helpers
    // -------------------------
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');

    function setStatus(txt) {
      statusEl.textContent = txt;
    }
    function setError(txt) {
      errorEl.textContent = txt || '';
    }

    // -------------------------
    // Initial game start
    // -------------------------
    function newGame() {
      game.reset();
      renderBoard();
      checkGameState();
    }
    newGame();

    // start engine attempt but allow fallback
    startEngine(3);

    // -------------------------
    // Firebase authentication (magic link) & logging
    // -------------------------
    const sendLinkBtn = document.getElementById('sendLinkBtn');
    const emailInput = document.getElementById('emailInput');
    let currentUserEmail = null;

    sendLinkBtn.addEventListener('click', async () => {
      const email = (emailInput.value || '').trim().toLowerCase();
      if (!email) { setError('Enter a valid email'); return; }
      setError('');
      const actionCodeSettings = {
        url: window.location.href,
        handleCodeInApp: true
      };
      try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem('emailForSignIn', email);
        alert('Magic link sent â€” check your email. If you do not see it, check spam/promotion folders.');
        setStatus('Magic link sent â€” check email');
      } catch (err) {
        console.error('sendSignInLinkToEmail error', err);
        setError('Failed to send link: ' + (err?.message || err));
      }
    });

    // complete sign in when returning from link
    async function tryCompleteSignIn() {
      try {
        if (isSignInWithEmailLink(auth, window.location.href)) {
          let email = localStorage.getItem('emailForSignIn');
          if (!email) {
            email = window.prompt('Enter the email used to sign in');
          }
          if (!email) return;
          const result = await signInWithEmailLink(auth, email, window.location.href);
          localStorage.removeItem('emailForSignIn');
          // user signed in
          setStatus('Signed in: ' + (result.user.email || 'unknown') + ' â€” Starting AI match');
        }
      } catch (err) {
        console.error('Error completing sign-in', err);
      }
    }
    tryCompleteSignIn();

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserEmail = user.email || null;
        setStatus('Signed in: ' + (currentUserEmail || '(no-email)') + ' â€” Starting AI match');
        // log to firestore
        try {
          await addDoc(collection(db, 'logins'), { email: currentUserEmail || 'unknown', ts: serverTimestamp() });
        } catch (err) {
          console.error('Firestore log failed', err);
        }
        // start engine if not started
        if (!engine && !fallback) startEngine(3);
        newGame(); // reset and start match for user
      } else {
        currentUserEmail = null;
        setStatus('Not signed in â€” enter your email and click "Send Magic Link"');
        if (engine) { try { engine.terminate(); } catch (e) {} engine = null; engineReady = false; engineAvailable = false; }
        newGame();
      }
    });

    // -------------------------
    // Buttons hooks
    // -------------------------
    document.getElementById('connectBtn').addEventListener('click', () => {
      alert('Wallet connect placeholder â€” integrate BSC wallet (e.g. WalletConnect / MetaMask BSC) here');
    });

    document.getElementById('createBtn').addEventListener('click', () => {
      alert('Create Game placeholder â€” implement on-chain game creation/stake flow here');
    });

    // safeguard: if Stockfish worker fails to load in the browser (CSP/CORS), we already fallback;
    // show an informative message after short timeout if no engine & fallback.
    setTimeout(() => {
      if (!engine && fallback) {
        setError('Engine not available in this environment â€” using fallback AI (weaker).');
      }
    }, 2200);

    // expose minimal global for debugging (optional)
    window.sscwc = { game, renderBoard, aiMakeMove, startEngine };

  </script>
</body>
</html>
