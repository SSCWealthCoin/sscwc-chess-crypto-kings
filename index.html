<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SSCWC Chess Crypto Kings</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  body{ margin:0; font-family:"Poppins", Arial, sans-serif; background:#000; color:#ffd700; text-align:center }
  h1{ font-size:1.6rem; margin:10px 0 0; color:#ffd700 }
  h2.slogan{ font-style:italic; color:#fddb6b; margin:4px 0 12px }

  /* Header coin */
  #top3D{ width:100%; height:140px; display:flex; justify-content:center; align-items:center; background:radial-gradient(circle at 50% 30%, rgba(255,215,0,0.03), transparent 25%), #000 }
  .coin{ width:110px; height:110px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffdf00 0%, #b8860b 90%); display:flex; justify-content:center; align-items:center; box-shadow: inset 3px 3px 6px rgba(255,255,255,0.25), inset -3px -3px 8px rgba(0,0,0,0.35), 0 0 25px rgba(255,215,0,0.6); animation: spin 9s linear infinite; transform-style: preserve-3d }
  @keyframes spin{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}
  .coin svg{ width:58px; height:58px; filter: drop-shadow(0 0 6px rgba(255,215,0,0.12)); }

  /* Controls */
  .toolbar{ margin:10px 0; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap }
  input[type="email"]{ padding:8px 10px; border-radius:8px; border:1px solid #444; width:220px; background:#111; color:#fff }
  button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }
  .btn-pink{ background:#ff4fd8; color:#fff }
  .btn-blue{ background:#0099ff; color:#fff }
  .btn-green{ background:#29a745; color:#fff }
  .btn-yellow{ background:#ffc107; color:#000 }

  /* Chess area */
  #chessWrap{ padding:28px 12px; background: radial-gradient(circle at center, #000 60%, #111 100%); border-top:2px solid gold; box-shadow:0 0 20px rgba(255,200,50,0.06); display:flex; justify-content:center }
  #board{ width:min(560px,94vw); aspect-ratio:1/1; display:grid; grid-template-columns:repeat(8,1fr); grid-template-rows:repeat(8,1fr); border:2px solid gold; box-shadow:0 0 15px rgba(200,160,30,0.18); background-clip:padding-box }
  .square{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; user-select:none }
  .light{ background:#f0d9b5 }
  .dark{ background:#b58863 }
  .square svg{ width:78%; height:78%; max-width:44px; max-height:44px; pointer-events:none }
  @media (max-width:420px){ .square svg{ width:72%; height:72% } }

  /* status */
  #status{ margin-top:8px; color:#fff8; font-size:0.95rem }
</style>
</head>
<body>

  <div id="top3D"><div class="coin" aria-hidden="true">
    <!-- Flat Bitcoin-like "B" icon -->
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M45 25h10a10 10 0 0 1 0 20h-10zM45 45h12a10 10 0 0 1 0 20H45z" fill="#fff8dc" stroke="none"/>
      <rect x="43" y="15" width="4" height="70" fill="#fff8dc"/>
      <rect x="53" y="15" width="4" height="70" fill="#fff8dc"/>
    </svg>
  </div></div>

  <h1>SSCWC Chess Crypto Kings</h1>
  <h2 class="slogan">The Future of Gold on Blockchain</h2>

  <div class="toolbar" id="authToolbar">
    <input id="emailInput" type="email" placeholder="Your email (for quick sign-in)" />
    <button id="sendLinkBtn" class="btn-pink">Send Magic Link</button>
    <button id="connectBtn" class="btn-blue">Connect Wallet (BSC Testnet)</button>
    <button id="createBtn" class="btn-green">Create Game</button>
  </div>

  <div id="status">Not signed in — enter your email and click "Send Magic Link"</div>

  <div id="chessWrap">
    <div id="board" role="grid" aria-label="Chessboard"></div>
  </div>

  <!-- Required libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.6/dist/chess.min.js"></script>

  <script>
    const STOCKFISH_WORKER_URL = 'https://cdn.jsdelivr.net/npm/stockfish@15.1.0/src/stockfish.js';
  </script>

  <!-- Firebase + Chess Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiU4bLmbd5pJ6sv13TAMIk4eh8Exhid4o",
      authDomain: "sscwc-chess.firebaseapp.com",
      databaseURL: "https://sscwc-chess-default-rtdb.firebaseio.com",
      projectId: "sscwc-chess",
      storageBucket: "sscwc-chess.firebasestorage.app",
      messagingSenderId: "382398698085",
      appId: "1:382398698085:web:cc902f0f1b6b1b93602c8c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById('emailInput');
    const sendLinkBtn = document.getElementById('sendLinkBtn');
    const status = document.getElementById('status');
    const boardEl = document.getElementById('board');

    const Chess = window.Chess;
    const game = new Chess();
    const files = ['a','b','c','d','e','f','g','h'];

    function buildEmptyBoard(){
      boardEl.innerHTML = '';
      for(let r=0;r<8;r++){
        for(let f=0;f<8;f++){
          const sq = document.createElement('div');
          sq.className = 'square ' + ((r+f)%2===0 ? 'light' : 'dark');
          sq.dataset.square = files[f] + (8 - r);
          boardEl.appendChild(sq);
        }
      }
    }
    buildEmptyBoard();

    // simplified piece SVG generator (same as before)
    function svgFor(type, color){
      const goldFill='#D4AF37', goldRim='#B8860B', silverFill='#C0C0C0', silverRim='#9E9E9E';
      const fill=color==='w'?goldFill:silverFill, rim=color==='w'?goldRim:silverRim, highlight='#fff9e6';
      switch(type){
        case 'p': return `<svg viewBox="0 0 120 120"><circle cx="60" cy="38" r="15" fill="${rim}"/><circle cx="60" cy="38" r="12" fill="${fill}"/></svg>`;
        case 'q': return `<svg viewBox="0 0 120 120"><path d="M24 62 L34 40 L46 62 L60 36 L74 62 L86 40 L96 62 L96 76 L24 76 Z" fill="${rim}"/><circle cx="60" cy="36" r="4" fill="${highlight}"/></svg>`;
        default: return `<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="40" fill="${fill}" stroke="${rim}" stroke-width="4"/></svg>`;
      }
    }

    function renderBoard(){
      const squares = boardEl.querySelectorAll('.square');
      squares.forEach(sq => sq.innerHTML = '');
      const boardObj = game.board();
      for(let r = 0; r < 8; r++){
        for(let f = 0; f < 8; f++){
          const piece = boardObj[r][f];
          if(piece){
            const squareIndex = r*8 + f;
            const sqEl = boardEl.children[squareIndex];
            sqEl.innerHTML = svgFor(piece.type, piece.color === 'w' ? 'w' : 'b');
          }
        }
      }
    }

    function newGame(){
      game.reset();
      renderBoard();
      status.textContent = currentUserEmail ? 'Playing AI (level 3)' : 'Not signed in — sign in to play';
    }

    let currentUserEmail = null;
    let engine = null, engineReady = false;

    function startEngine(skill=3){
      try {
        engine && engine.terminate();
        engine = new Worker(STOCKFISH_WORKER_URL);
      } catch(e){ console.error('Stockfish worker failed', e); }
      engine.onmessage = (e) => {
        const msg = e.data;
        if(msg.startsWith('uciok')) { engine.postMessage('isready'); }
        if(msg.startsWith('readyok')){ engineReady = true; engine.postMessage('ucinewgame'); engine.postMessage('setoption name Skill Level value ' + skill); }
        if(msg.startsWith('bestmove')){
          const best = msg.split(' ')[1];
          const from = best.substring(0,2), to = best.substring(2,4);
          game.move({from,to,promotion:'q'}); renderBoard();
        }
      };
      engine.postMessage('uci');
    }

    function aiMove(){
      if(!engine || !engineReady) return;
      engine.postMessage('position fen ' + game.fen());
      engine.postMessage('go depth 12');
    }

    // ✅ Send Magic Link
    sendLinkBtn.addEventListener('click', async () => {
      const email = emailInput.value?.trim().toLowerCase();
      if(!email){ alert('Enter a valid email'); return; }

      const actionCodeSettings = {
        url: 'https://sscwealthcoin.github.io/',
        handleCodeInApp: true
      };

      try {
        console.log('Sending magic link to', email);
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem('emailForSignIn', email);
        alert('Magic link sent! Check your inbox or spam folder.');
        status.textContent = 'Magic link sent — waiting for confirmation';
      } catch (err) {
        console.error('sendSignInLinkToEmail failed:', err);
        alert('Failed to send link: ' + (err.message || err));
      }
    });

    // ✅ Complete Sign-in after clicking link
    async function tryCompleteSignIn(){
      try {
        if(isSignInWithEmailLink(auth, window.location.href)){
          let email = localStorage.getItem('emailForSignIn') || window.prompt('Enter the email you used to sign in');
          if(!email) return;
          const result = await signInWithEmailLink(auth, email, window.location.href);
          localStorage.removeItem('emailForSignIn');
          status.textContent = 'Signed in: ' + result.user.email;
        }
      } catch (err) {
        console.error('Error completing sign-in:', err);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(user){
        currentUserEmail = user.email;
        console.log('User signed in:', currentUserEmail);
        status.textContent = 'Signed in: ' + currentUserEmail + ' — Starting AI match';
        try{
          await addDoc(collection(db,'logins'), { email: currentUserEmail, ts: serverTimestamp() });
        }catch(e){ console.error('Firestore log failed', e); }
        startEngine(3);
        newGame();
      } else {
        currentUserEmail = null;
        status.textContent = 'Not signed in — enter your email and click "Send Magic Link"';
        if(engine){ try{ engine.terminate(); }catch(e){} engine=null; engineReady=false; }
        newGame();
      }
    });

    tryCompleteSignIn();

    document.getElementById('connectBtn').addEventListener('click', ()=>alert('Connect Wallet placeholder'));
    document.getElementById('createBtn').addEventListener('click', ()=>alert('Create Game placeholder'));
    newGame();
  </script>
</body>
</html>
